name: Automated Code Review

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Clear npm cache
      run: npm cache clean --force

    - name: Install dependencies
      run: npm install

    - name: Run ESLint
      run: npm run lint || echo "ESLint not configured"
      continue-on-error: true

    - name: Build project
      run: npm run build

    - name: Run tests
      run: npm test || echo "Tests not configured"
      continue-on-error: true

  code-quality:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm install

    - name: Check code quality
      run: |
        echo "=== Code Quality Report ===" >> $GITHUB_STEP_SUMMARY
        echo "| í•­ëª© | ìƒíƒœ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|" >> $GITHUB_STEP_SUMMARY
        
        # íŒŒì¼ êµ¬ì¡° ê²€ì‚¬
        if [ -f "src/App.vue" ]; then
          echo "| Vue ì•± êµ¬ì¡° | âœ… ì •ìƒ |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Vue ì•± êµ¬ì¡° | âŒ App.vue ëˆ„ë½ |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # ì»´í¬ë„ŒíŠ¸ ê²€ì‚¬
        COMPONENTS=$(find src/components -name "*.vue" 2>/dev/null | wc -l)
        echo "| ì»´í¬ë„ŒíŠ¸ ìˆ˜ | $COMPONENTS ê°œ |" >> $GITHUB_STEP_SUMMARY
        
        # ë¼ìš°í„° ê²€ì‚¬
        if [ -f "src/router/index.js" ]; then
          echo "| ë¼ìš°í„° ì„¤ì • | âœ… ì •ìƒ |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ë¼ìš°í„° ì„¤ì • | âŒ ë¼ìš°í„° ëˆ„ë½ |" >> $GITHUB_STEP_SUMMARY
        fi
        
        # íŒ¨í‚¤ì§€ ì˜ì¡´ì„± ê²€ì‚¬
        echo "| ì˜ì¡´ì„± íŒ¨í‚¤ì§€ | $(jq '.dependencies | length' package.json) ê°œ |" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ê°œì„  ì œì•ˆ" >> $GITHUB_STEP_SUMMARY
        echo "- ëª¨ë“  ì»´í¬ë„ŒíŠ¸ì—ì„œ scoped ìŠ¤íƒ€ì¼ ì‚¬ìš© í™•ì¸" >> $GITHUB_STEP_SUMMARY
        echo "- ë°˜ì‘í˜• ë””ìì¸ ì ìš© ìƒíƒœ ê²€í† " >> $GITHUB_STEP_SUMMARY
        echo "- ì ‘ê·¼ì„±(a11y) ê°€ì´ë“œë¼ì¸ ì¤€ìˆ˜ ê²€í† " >> $GITHUB_STEP_SUMMARY

  deploy-preview:
    runs-on: ubuntu-latest
    needs: [lint-and-test]
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm install

    - name: Build for preview
      run: npm run build

    - name: Deploy preview comment
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `
          ## ğŸš€ ë°°í¬ ë¯¸ë¦¬ë³´ê¸° ì¤€ë¹„ ì™„ë£Œ
          
          ë¹Œë“œê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!
          
          ### ğŸ“Š ë¹Œë“œ ì •ë³´
          - Node.js ë²„ì „: 20
          - ë¹Œë“œ ë„êµ¬: Vite
          - ì»¤ë°‹: ${context.sha.substring(0, 7)}
          
          ### ğŸ” ë‹¤ìŒ ë‹¨ê³„
          1. ë¡œì»¬ì—ì„œ \`npm run preview\` ì‹¤í–‰í•˜ì—¬ í™•ì¸
          2. ë°˜ì‘í˜• ë””ìì¸ í…ŒìŠ¤íŠ¸
          3. ë¸Œë¼ìš°ì € í˜¸í™˜ì„± í™•ì¸
          
          *ì´ ëŒ“ê¸€ì€ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*
            `
          })
