name: Vue.js Quality Check

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/**/*.vue'
      - 'src/**/*.js'
      - 'package*.json'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/**/*.vue'
      - 'src/**/*.js'
      - 'package*.json'

jobs:
  vue-analysis:
    runs-on: ubuntu-latest
    name: Vue.js ì½”ë“œ í’ˆì§ˆ ë¶„ì„

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm install

    - name: Vue ì»´í¬ë„ŒíŠ¸ ë¶„ì„
      run: |
        echo "## ğŸ” Vue.js í”„ë¡œì íŠ¸ ë¶„ì„ ê²°ê³¼" >> analysis.md
        echo "" >> analysis.md
        
        # ì»´í¬ë„ŒíŠ¸ ìˆ˜ ê³„ì‚°
        COMPONENT_COUNT=$(find src/components -name "*.vue" 2>/dev/null | wc -l)
        echo "### ğŸ“Š í”„ë¡œì íŠ¸ í†µê³„" >> analysis.md
        echo "- **ì»´í¬ë„ŒíŠ¸ ìˆ˜**: $COMPONENT_COUNT ê°œ" >> analysis.md
        
        # Vue íŒŒì¼ í¬ê¸° ë¶„ì„
        echo "- **Vue íŒŒì¼ ì´ í¬ê¸°**: $(du -sh src/ | cut -f1)" >> analysis.md
        
        # ìŠ¤íƒ€ì¼ ë¶„ì„
        SCOPED_STYLES=$(grep -r "style scoped" src/ | wc -l)
        echo "- **Scoped ìŠ¤íƒ€ì¼ ì‚¬ìš©**: $SCOPED_STYLES ê°œ íŒŒì¼" >> analysis.md
        
        # Composition API ì‚¬ìš© í™•ì¸
        SETUP_COUNT=$(grep -r "script setup" src/ | wc -l)
        echo "- **Composition API ì‚¬ìš©**: $SETUP_COUNT ê°œ íŒŒì¼" >> analysis.md
        
        echo "" >> analysis.md
        echo "### ğŸ¯ í’ˆì§ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸" >> analysis.md
        
        # ê° Vue íŒŒì¼ì— ëŒ€í•œ ì²´í¬
        for file in $(find src -name "*.vue"); do
          echo "#### $(basename $file)" >> analysis.md
          
          # Template ì²´í¬
          if grep -q "<template>" "$file"; then
            echo "- âœ… Template êµ¬ì¡° ì •ìƒ" >> analysis.md
          else
            echo "- âŒ Template êµ¬ì¡° ëˆ„ë½" >> analysis.md
          fi
          
          # Script setup ì²´í¬
          if grep -q "script setup" "$file"; then
            echo "- âœ… Composition API ì‚¬ìš©" >> analysis.md
          else
            echo "- âš ï¸ Options API ì‚¬ìš© (Composition API ê¶Œì¥)" >> analysis.md
          fi
          
          # Scoped ìŠ¤íƒ€ì¼ ì²´í¬
          if grep -q "style scoped" "$file"; then
            echo "- âœ… Scoped ìŠ¤íƒ€ì¼ ì‚¬ìš©" >> analysis.md
          else
            echo "- âš ï¸ Scoped ìŠ¤íƒ€ì¼ ë¯¸ì‚¬ìš©" >> analysis.md
          fi
          
          echo "" >> analysis.md
        done
        
        echo "### ğŸš€ ê°œì„  ê¶Œì¥ì‚¬í•­" >> analysis.md
        echo "1. **ë°˜ì‘í˜• ë””ìì¸**: ëª¨ë“  ì»´í¬ë„ŒíŠ¸ì—ì„œ ë¯¸ë””ì–´ ì¿¼ë¦¬ í™•ì¸" >> analysis.md
        echo "2. **ì ‘ê·¼ì„±**: alt ì†ì„±, aria-label ë“± ì ‘ê·¼ì„± ìš”ì†Œ ì¶”ê°€" >> analysis.md
        echo "3. **ì„±ëŠ¥ ìµœì í™”**: ì´ë¯¸ì§€ lazy loading, ì»´í¬ë„ŒíŠ¸ ë¶„í•  ê³ ë ¤" >> analysis.md
        echo "4. **ì½”ë“œ ì¼ê´€ì„±**: ESLint, Prettier ì„¤ì • ê¶Œì¥" >> analysis.md

    - name: ë°˜ì‘í˜• ë””ìì¸ ì²´í¬
      run: |
        echo "" >> analysis.md
        echo "### ğŸ“± ë°˜ì‘í˜• ë””ìì¸ ë¶„ì„" >> analysis.md
        
        # CSS ë¯¸ë””ì–´ ì¿¼ë¦¬ ì‚¬ìš© í™•ì¸
        MEDIA_QUERIES=$(grep -r "@media" src/ | wc -l)
        echo "- **ë¯¸ë””ì–´ ì¿¼ë¦¬ ì‚¬ìš©**: $MEDIA_QUERIES ê°œ" >> analysis.md
        
        # ìì£¼ ì‚¬ìš©ë˜ëŠ” ë°˜ì‘í˜• íŒ¨í„´ í™•ì¸
        FLEX_USAGE=$(grep -r "display: flex\|d-flex" src/ | wc -l)
        echo "- **Flexbox ì‚¬ìš©**: $FLEX_USAGE ê°œ" >> analysis.md
        
        GRID_USAGE=$(grep -r "display: grid\|grid-template" src/ | wc -l)
        echo "- **CSS Grid ì‚¬ìš©**: $GRID_USAGE ê°œ" >> analysis.md

    - name: ë¶„ì„ ê²°ê³¼ ì—…ë¡œë“œ
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          if (fs.existsSync('analysis.md')) {
            const analysis = fs.readFileSync('analysis.md', 'utf8');
            
            if (context.eventName === 'pull_request') {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: analysis
              });
            }
            
            // Summaryì—ë„ ì¶”ê°€
            await core.summary.addRaw(analysis).write();
          }

  security-check:
    runs-on: ubuntu-latest
    name: ë³´ì•ˆ ê²€ì‚¬

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: ì˜ì¡´ì„± ë³´ì•ˆ ê²€ì‚¬
      run: |
        npm audit --audit-level=moderate || echo "ë³´ì•ˆ ì·¨ì•½ì ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤."

    - name: í™˜ê²½ë³€ìˆ˜ ë…¸ì¶œ ê²€ì‚¬
      run: |
        echo "## ğŸ”’ ë³´ì•ˆ ê²€ì‚¬ ê²°ê³¼" >> security.md
        echo "" >> security.md
        
        # API í‚¤ ë…¸ì¶œ ê²€ì‚¬
        if grep -r "api.key\|apikey\|secret\|password" src/ --exclude-dir=node_modules; then
          echo "âš ï¸ **ì£¼ì˜**: í•˜ë“œì½”ë”©ëœ API í‚¤ë‚˜ ë¹„ë°€ì •ë³´ê°€ ë°œê²¬ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤." >> security.md
          echo "í™˜ê²½ë³€ìˆ˜(.env) ì‚¬ìš©ì„ ê¶Œì¥í•©ë‹ˆë‹¤." >> security.md
        else
          echo "âœ… í•˜ë“œì½”ë”©ëœ ë¯¼ê°ì •ë³´ ì—†ìŒ" >> security.md
        fi
        
        echo "" >> security.md
        echo "### ë³´ì•ˆ ê¶Œì¥ì‚¬í•­" >> security.md
        echo "- ì¹´ì¹´ì˜¤ë§µ API í‚¤ëŠ” í™˜ê²½ë³€ìˆ˜ë¡œ ê´€ë¦¬" >> security.md
        echo "- .env íŒŒì¼ì€ .gitignoreì— í¬í•¨" >> security.md
        echo "- ì •ê¸°ì ì¸ ì˜ì¡´ì„± ì—…ë°ì´íŠ¸" >> security.md

    - name: ë³´ì•ˆ ê²°ê³¼ ì—…ë¡œë“œ
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          if (fs.existsSync('security.md')) {
            const security = fs.readFileSync('security.md', 'utf8');
            await core.summary.addRaw(security).write();
          }
